\documentclass{article}

\RequirePackage[T1]{fontenc} 
%\usepackage[tt=false, type1=true]{libertine} 
\RequirePackage[varqu]{zi4} 
\RequirePackage[libertine]{newtxmath}

\usepackage{comment}

\usepackage{fullpage}
\usepackage{graphicx} % Required for inserting images

\usepackage{mathpartir}
\usepackage{amsmath}
%\usepackage{amssymb}
%\usepackage{mathtools}
%\usepackage{xfrac,unicode-math}
% \usepackage{amsthm}
%\usepackage{amsthm}
\newtheorem{lemma}{Lemma}


\title{Contextual Typing (System F)}
\author{Xu Xue}

\begin{document}

\maketitle

\section{Syntax}

\subsection{Decl.}

\begin{align*}
&\text{Types} \quad\quad &A, B, C, D ::=&~ a \mid \mathtt{Int} \mid A \rightarrow B \mid \forall a.~A\\
&\text{Expressions} \quad \quad &e::=&~ i \mid x \mid \lambda x . ~e \mid e_1~e_2 \mid e : A \mid \Lambda a.~e \mid e[A]\\
&\text{Environments} \quad\quad &\Gamma::=&~ . \mid \Gamma, x : A \mid \Gamma, a \mid \Gamma, \hat{a} = A\\
&\text{Counters} \quad\quad &n ::=&~ 0 \mid \infty \mid S~n \mid S_{\tau}~n\\
\end{align*}

\subsection{Algo.}

\begin{align*}
    &\text{Contexts} \quad\quad &\Sigma ::=&~ A \mid \square \mid \boxed{e} \leadsto \Sigma \mid \boxed{A} \leadsto \Sigma\\
    &\text{Generic Consumers} \quad \quad &g::=&~ i \mid x \mid e : A\\
    &\text{Environments} \quad\quad &\Gamma ::=&~ . \mid \Gamma, x : A \mid \Gamma, a \mid \Gamma, \hat{a} \mid \Gamma, \hat{a}= A\\
\end{align*}


\section{Decl.}

\subsection{Typing}

\begin{mathpar}
    \inferrule*[lab=Int]
    { }
    {\Gamma \vdash_0 i : \mathtt{Int}}

    \inferrule*[lab=Var]
    {x : A \in \Gamma}
    {\Gamma \vdash_0 x : A}

    \inferrule*[lab=Ann]
    {\Gamma \vdash_{\infty} e : A}
    {\Gamma \vdash_0 (e : A) : A}

    \inferrule*[lab=Lam]
    {\Gamma, x : A \vdash_{n-} e : B}
    {\Gamma \vdash_{n} \lambda x.~ e : A \rightarrow B}

    \inferrule*[lab=App1]
    {\Gamma \vdash_0 e_1 : A \rightarrow B \\
    \Gamma \vdash_{\infty} e_2 : A}
    {\Gamma \vdash_n e_1~e_2 : B}

    \inferrule*[lab=App2]
    {\Gamma \vdash_{S ~n} e_1 : A \rightarrow B \\
    \Gamma \vdash_0 e_2 : A}
    {\Gamma \vdash_n e_1~e_2 : B}

    \inferrule*[lab=Sub]
    {\Gamma \vdash_0 e : B \\
    \Gamma \vdash B <:_n A}
    {\Gamma \vdash_n e : A}

    \inferrule*[lab=TAbs1]
    {\Gamma, a \vdash_0 e : A}
    {\Gamma \vdash_0 \Lambda a.~e : \forall a.~A}
    
%    \inferrule*[lab=TAbs2]
%    {\Gamma, a \vdash_n e : B}
%    {\Gamma \vdash_{S_\tau ~n} \Lambda a.~e :  [A/a] B}


    \inferrule*[lab=TApp]
    {\Gamma \vdash_{S_{\tau}~n} e : B}
    {\Gamma \vdash_n e~[A] : B}
\end{mathpar}

\subsection{Subtyping}

\begin{mathpar}
    \inferrule*[lab=S-Refl]
    { }
    {\Gamma \vdash_0 A <: \Gamma(A)}

    \inferrule*[lab=S-Int]
    { }
    {\Gamma \vdash_{\infty} \mathtt{Int} <: \mathtt{Int}}
    
    \inferrule*[lab=S-Var]
    { }
    {\Gamma \vdash_\infty a <: a}

    \inferrule*[lab=S-Arr]
    {\Gamma \vdash_{\infty} C <: A \\
     \Gamma \vdash_{n-} B <: D}
    {\Gamma \vdash_n A \rightarrow B <:C \rightarrow D}

    \inferrule*[lab=S-$\forall$]
    {\Gamma , a \vdash_{\infty} A <: B}
    {\Gamma \vdash_{\infty} \forall a.~A <: \forall a.~B}

    \inferrule*[lab=S-$\forall$L]
    {\Gamma \vdash B \\
     \Gamma, \hat{a} = B \vdash_{n}  A <: C}
    {\Gamma \vdash_{S~n} \forall a. ~A <: C}
    
    \inferrule*[lab=S-$\forall$L-t]
    {\Gamma \vdash B \\
     \Gamma, \hat{a} = B \vdash_{n}  A <: C}
    {\Gamma \vdash_{S_\tau~n} \forall a. ~A <: C}    
    
    \inferrule*[lab=S-var-l]
    {\hat{a} = B \in \Gamma \\ \Gamma \vdash_n B <: A}
    {\Gamma \vdash_n \hat{a} <: A}
    
        \inferrule*[lab=S-var-r]
    {\hat{a} = B \in \Gamma \\ \Gamma \vdash_n A <: B}
    {\Gamma \vdash_n A <: \hat{a}}
\end{mathpar}

\section{Algo.}

\subsection{Typing: $\boxed{\Gamma \vdash \Sigma \Rightarrow e \Rightarrow A}$}

\begin{mathpar}
\inferrule*[lab=T-Lit]
{ }
{\Gamma \vdash \square \Rightarrow i \Rightarrow \mathsf{Int}}

\inferrule*[lab=T-Var]
{x : A \in \Gamma}
{\Gamma \vdash \square \Rightarrow x \Rightarrow A}

\inferrule*[lab=T-Ann]
{\Gamma \vdash A \Rightarrow e \Rightarrow B}
{\Gamma \vdash \square \Rightarrow e : A \Rightarrow A}

\inferrule*[lab=T-App]
{\Gamma \vdash \boxed{e_2} \leadsto \Sigma \Rightarrow e_1 \Rightarrow A \rightarrow B}
{\Gamma \vdash \Sigma \Rightarrow e_1~e_2 \Rightarrow B}

\inferrule*[lab=T-Lam1]
{\Gamma, x : A \vdash B \Rightarrow e \Rightarrow C}
{\Gamma \vdash A \rightarrow B \Rightarrow \lambda x.~e \Rightarrow A \rightarrow C}

\inferrule*[lab=T-Lam2]
{\Gamma \vdash \square \Rightarrow e_2 \Rightarrow A\\
 \Gamma , x : A \vdash \Sigma \Rightarrow e \Rightarrow B}
{\Gamma \vdash \boxed{e_2} \leadsto \Sigma \Rightarrow \lambda x.~e \Rightarrow A \rightarrow B}

\inferrule*[lab=T-Sub]
{\Gamma \vdash \square \Rightarrow g \Rightarrow A \\
 \Gamma \vdash A <: \Sigma \dashv \Gamma' \rightsquigarrow B}
{\Gamma \vdash \Sigma \Rightarrow g \Rightarrow B}

\inferrule*[lab=T-TAbs1]
{\Gamma, a \vdash \square \Rightarrow e \Rightarrow A}
{\Gamma \vdash \square \Rightarrow \Lambda a.~e \Rightarrow \forall a.~A}

%\inferrule*[lab=T-TAbs2]
%{\Gamma, a \vdash \Sigma  \Rightarrow e \Rightarrow B}
%{\Gamma \vdash \boxed{A} \leadsto \Sigma \Rightarrow \Lambda a. ~e \Rightarrow [A/a]B}

\inferrule*[lab=T-TApp]
%{\Gamma \vdash H \Rightarrow e \Rightarrow \forall X.~B}
{\Gamma \vdash \boxed{A} \leadsto \Sigma \Rightarrow e \Rightarrow B}
{\Gamma \vdash  \Sigma \Rightarrow e[A] \Rightarrow B}

\end{mathpar}

\begin{comment}
\subsection{Subtyping: $\boxed{\Gamma \vdash A <: \Sigma \dashv \Gamma' \rightsquigarrow A}$}

\begin{mathpar}
\inferrule*[lab=S-Int]
{ }
{\Gamma \vdash \mathtt{Int} <: \mathtt{Int} \dashv \Gamma \rightsquigarrow \mathtt{Int}}

\inferrule*[lab=S-Empty]
{FV_{ex}(\Gamma, A) = . \\ \Gamma \vdash A}
{\Gamma \vdash A <: \square \dashv \Gamma \rightsquigarrow A}

\inferrule*[lab=S-Ex-L]
{FV_{ex}(\Gamma, A) = . \\ \Gamma \vdash A}
{\Gamma \vdash \hat{a} <: A \dashv [A/\hat{a}]~\Gamma \rightsquigarrow A}

\inferrule*[lab=S-Ex-R]
{FV_{ex}(\Gamma, A) = . \\ \Gamma \vdash A}
{\Gamma \vdash A <: \hat{a} \dashv [A/\hat{a}]~\Gamma \rightsquigarrow A}

\inferrule*[lab=S-Arr]
{\Gamma \vdash C <: A \dashv \Gamma_1 \rightsquigarrow A' \\
 \Gamma_1 \vdash B <: D \dashv \Gamma_2 \rightsquigarrow D'}
{\Gamma \vdash A \rightarrow B <: C \rightarrow D \dashv \Gamma_2 \rightsquigarrow C \rightarrow D}

\inferrule*[lab=S-Hole-No-Ex]
{ FV_{ex}(\Gamma, A) = . \\
\Gamma \vdash A \Rightarrow e \Rightarrow C\\
 \Gamma \vdash B <: \Sigma \dashv \Gamma' \rightsquigarrow D}
{\Gamma \vdash A \rightarrow B <: \boxed{e} \leadsto \Sigma \dashv \Gamma' \rightsquigarrow A \rightarrow D}

\inferrule*[lab=S-Hole-Ex]
{ FV_{ex}(A) \neq . \\
\Gamma \vdash \square \Rightarrow e \Rightarrow C\\
\Gamma \vdash C <: A \dashv \Gamma_1 \rightsquigarrow A' \\
\Gamma_1 \vdash B <: \Sigma \dashv \Gamma_2 \rightsquigarrow D}
{\Gamma \vdash A \rightarrow B <: \boxed{e} \leadsto \Sigma \dashv \Gamma_2 \rightsquigarrow A' \rightarrow D}

\inferrule*[lab=S-All]
{\Gamma, a \vdash A <: B \dashv \Gamma', a\rightsquigarrow C}
{\Gamma \vdash \forall a. A <: \forall a. B \dashv \Gamma' \rightsquigarrow \forall a. C}

\inferrule*[lab=S-All-L]
{\Gamma, \hat{a} \vdash [\hat{a}/a]A <: \boxed{e} \leadsto \Sigma \dashv \Gamma', \hat{a} \rightsquigarrow B}
{\Gamma \vdash \forall a. A <: \boxed{e} \leadsto \Sigma \dashv \Gamma' \rightsquigarrow B}
\end{mathpar}
\end{comment}

\subsection{Subtyping (Well-Scoped De Bruijn): $\boxed{\Gamma \vdash A <: \Sigma \dashv \Gamma' \rightsquigarrow A'}$}

\begin{align*}
    &\text{Environments} \quad\quad &\Gamma ::=&~ . \mid \Gamma, A \mid \Gamma, o \mid \Gamma, \widehat{A} \\
    &\text{Subtyping Environments} \quad\quad &\Psi :=&~ \Gamma \mid \Psi, o \mid \Psi, \hat{o} \mid \Psi , \widehat{A}\\
\end{align*}
\begin{mathpar}
\inferrule*[lab=S-Int]
{ }
{\Psi \vdash \mathtt{Int} <: \mathtt{Int} \dashv \Psi \rightsquigarrow \mathtt{Int}}

\inferrule*[lab=S-Empty]
{\Psi \vdash_{close} A}
{\Psi \vdash A <: \square \dashv \Psi \rightsquigarrow \Psi(A)}

\inferrule*[lab=S-Var]
{ }
{\Psi \vdash a <: a \dashv \Psi \rightsquigarrow a}


\inferrule*[lab=S-Ex-L]
{\hat{a} \in \Psi \\
\Psi \vdash_{close} A}
{\Psi \vdash a <: A \dashv [A/a]~\Psi \rightsquigarrow A}

\inferrule*[lab=S-Ex-L-eq]
{\hat{a} = B \in \Psi \\
\Psi \vdash B <: A \dashv \Psi_1 \rightsquigarrow A'\\
\Psi_1 \vdash A <: B \dashv \Psi_2 \rightsquigarrow A''\\
\Psi \vdash_{close} A}
{\Psi \vdash a <: A \dashv \Psi_2 \rightsquigarrow A''}

\inferrule*[lab=S-Ex-R]
{\hat{a} \in \Psi \\
\Psi \vdash_{close} A}
{\Psi \vdash A <: a \dashv [A/a]~\Psi \rightsquigarrow A}

\inferrule*[lab=S-Ex-R-eq]
{\hat{a} = B \in \Psi \\
\Psi \vdash B <: A \dashv \Psi_1 \rightsquigarrow A'\\
\Psi_1 \vdash A <: B \dashv \Psi_2 \rightsquigarrow A''\\
\Psi \vdash_{close} A}
{\Psi \vdash A <: a \dashv \Psi_2 \rightsquigarrow A''}

\inferrule*[lab=S-Ex-R]
{\Psi \vdash_{close} A\\ 
 \Psi \vdash A}
{\Psi \vdash A <: a \dashv [A/a]~\Psi \rightsquigarrow A}

\inferrule*[lab=S-Arr]
{\Psi \vdash C <: A \dashv \Psi_1 \rightsquigarrow A' \\
 \Psi_1 \vdash B <: D \dashv \Psi_2 \rightsquigarrow D'}
{\Psi \vdash A \rightarrow B <: C \rightarrow D \dashv \Psi_2 \rightsquigarrow C \rightarrow D}

\inferrule*[lab=S-Hole-No-Ex]
{ \Psi \vdash_{close} A \\
\| \Psi \| \vdash A \Rightarrow e \Rightarrow C\\
 \Psi \vdash B <: \Sigma \dashv \Psi' \rightsquigarrow D}
{\Psi \vdash A \rightarrow B <: \boxed{e} \leadsto \Sigma \dashv \Psi' \rightsquigarrow A \rightarrow D}

\inferrule*[lab=S-Hole-Ex]
{ \Psi \vdash_{open} A \\
\| \Psi \| \vdash \square \Rightarrow e \Rightarrow C\\
\Psi \vdash C <: A \dashv \Psi_1 \rightsquigarrow A' \\
\Psi_1 \vdash B <: \Sigma \dashv \Psi_2 \rightsquigarrow D}
{\Psi \vdash A \rightarrow B <: \boxed{e} \leadsto \Sigma \dashv \Psi_2 \rightsquigarrow A' \rightarrow D}

\inferrule*[lab=S-All]
{\Psi, o \vdash A <: B \dashv \Psi', o\rightsquigarrow C}
{\Psi \vdash \forall A <: \forall B \dashv \Psi' \rightsquigarrow \forall C}

\inferrule*[lab=S-All-L]
{\Psi, \hat{o} \vdash A <: \boxed{e} \leadsto \Sigma \dashv \Psi', \hat{o} \rightsquigarrow B}
{\Psi \vdash \forall A <: \boxed{e} \leadsto \Sigma \dashv \Psi' \rightsquigarrow B}

\inferrule*[lab=S-All-L-Eq]
{\Psi, \hat{o} \vdash A <: \boxed{e} \leadsto \Sigma \dashv \Psi', \widehat{A} \rightsquigarrow B}
{\Psi \vdash \forall A <: \boxed{e} \leadsto \Sigma \dashv \Psi' \rightsquigarrow B}

\inferrule*[lab=S-$\forall$-t]
{\Psi \vdash [ B ] A <: \Sigma \dashv \Psi' \rightsquigarrow B}
{\Psi \vdash \forall A <: \boxed{B} \leadsto \Sigma \dashv \Psi' \rightsquigarrow B }
\end{mathpar}

\subsection{Environment Replacement}

\begin{align*}
[A/\hat{a}] ~(\Psi , \hat{a}) &= \Psi, \hat{a}:=A\\
[A/\hat{a}]~(\Psi, \hat{b}) &= [A/\hat{a}]~\Psi , \hat{b}\\
%[A/\hat{a}]~(\Psi, \hat{a}:=B) &= \Psi, \hat{a}:=A \quad when~ B \approx A\\
%[A/\hat{a}]~(\Psi, \hat{b}:= B) &= [[\hat{b} := B] A/\hat{a}]~\Psi , \hat{b}:= B
\end{align*}


\end{document}