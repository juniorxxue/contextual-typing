module Record.Decl where

open import Record.Prelude
open import Record.Common

----------------------------------------------------------------------
--+                            Counter                             +--
----------------------------------------------------------------------

-- check counter
data CCounter : Set where
   Z : CCounter
   âˆ : CCounter
   Sâ‡ : CCounter â†’ CCounter
   Sl : CCounter â†’ CCounter

-- counter   
data Counter : Set where
   â™­ : (j : CCounter) â†’ Counter
   Sâ‡’ : Counter â†’ Counter

----------------------------------------------------------------------
--+                           Subtyping                            +--
----------------------------------------------------------------------

infix 5 _â‰¤_#_
data _â‰¤_#_ : Type â†’ Counter â†’ Type â†’ Set where
  â‰¤Z : âˆ€ {A}
    â†’ A â‰¤ â™­ Z # A
  â‰¤intâˆ :
      Int â‰¤ â™­ âˆ # Int
  â‰¤floatâˆ :
      Float â‰¤ â™­ âˆ # Float
  â‰¤top : âˆ€ {A}
    â†’ A â‰¤ â™­ âˆ # Top
  â‰¤arr-âˆ : âˆ€ {A B C D}
    â†’ C â‰¤ â™­ âˆ # A
    â†’ B â‰¤ â™­ âˆ # D
    â†’ A `â†’ B â‰¤ â™­ âˆ # C `â†’ D
  â‰¤rcdâˆ : âˆ€ {A B l}
    â†’ A â‰¤ â™­ âˆ # B
    â†’ Ï„âŸ¦ l â†¦ A âŸ§ â‰¤ (â™­ âˆ) # Ï„âŸ¦ l â†¦ B âŸ§
  â‰¤arr-Sâ‡ : âˆ€ {A B D j}
    â†’ A â‰¤ â™­ âˆ # A
    â†’ B â‰¤ â™­ j # D
    â†’ A `â†’ B â‰¤ â™­ (Sâ‡ j) # A `â†’ D
  â‰¤arr-Sâ‡’ : âˆ€ {A B D i}
    â†’ A â‰¤ â™­ âˆ # A
    â†’ B â‰¤ i # D
    â†’ A `â†’ B â‰¤ Sâ‡’ i # A `â†’ D    
  â‰¤rcd-Sl : âˆ€ {A B l j}
    â†’ A â‰¤ â™­ j # B
    â†’ Ï„âŸ¦ l â†¦ A âŸ§ â‰¤ â™­ (Sl j) # (Ï„âŸ¦ l â†¦ B âŸ§)
  â‰¤andâ‚ : âˆ€ {A B C j}
    â†’ A â‰¤ j # C
    â†’ j â‰¢ â™­ Z
    â†’ A & B â‰¤ j # C
  â‰¤andâ‚‚ : âˆ€ {A B C j}
    â†’ B â‰¤ j # C
    â†’ j â‰¢ â™­ Z
    â†’ A & B â‰¤ j # C
  â‰¤and : âˆ€ {A B C}
    â†’ A â‰¤ â™­ âˆ # B
    â†’ A â‰¤ â™­ âˆ # C
    â†’ A â‰¤ â™­ âˆ # B & C

â‰¤refl0 : âˆ€ {A} â†’ A â‰¤ â™­ Z # A
â‰¤refl0 = â‰¤Z

â‰¤reflâˆ : âˆ€ {A} â†’ A â‰¤ â™­ âˆ # A
â‰¤reflâˆ {A = Int} = â‰¤intâˆ
â‰¤reflâˆ {A = Float} = â‰¤floatâˆ
â‰¤reflâˆ {A = Top} = â‰¤top
â‰¤reflâˆ {A = A `â†’ Aâ‚} = â‰¤arr-âˆ â‰¤reflâˆ â‰¤reflâˆ
â‰¤reflâˆ {A = A & Aâ‚} = â‰¤and (â‰¤andâ‚ â‰¤reflâˆ Î» ()) (â‰¤andâ‚‚ â‰¤reflâˆ Î» ())
â‰¤reflâˆ {Ï„âŸ¦ l â†¦ A âŸ§} = â‰¤rcdâˆ â‰¤reflâˆ

----------------------------------------------------------------------
--+                                                                +--
--+                             Typing                             +--
--+                                                                +--
----------------------------------------------------------------------


infix 4 _âŠ¢_#_â¦‚_
infix 4 _âŠ¢r_#_â¦‚_

data _âŠ¢_#_â¦‚_ : Env â†’ Counter â†’ Term â†’ Type â†’ Set
data _âŠ¢r_#_â¦‚_ : Env â†’ Counter â†’ Record â†’ Type â†’ Set

data _âŠ¢_#_â¦‚_ where

  âŠ¢c : âˆ€ {Î“ c}
    â†’ Î“ âŠ¢ â™­ Z # ğ•” c â¦‚ c-Ï„ c

  âŠ¢var : âˆ€ {Î“ x A}
    â†’ Î“ âˆ‹ x â¦‚ A
    â†’ Î“ âŠ¢ â™­ Z # ` x â¦‚ A

  âŠ¢ann : âˆ€ {Î“ e A}
    â†’ Î“ âŠ¢ â™­ âˆ # e â¦‚ A
    â†’ Î“ âŠ¢ â™­ Z # (e â¦‚ A) â¦‚ A

  âŠ¢lamâ‚ : âˆ€ {Î“ e A B}
    â†’ Î“ , A âŠ¢ â™­ âˆ # e â¦‚ B
    â†’ Î“ âŠ¢ â™­ âˆ # (Æ› e) â¦‚ A `â†’ B

  âŠ¢lamâ‚‚ : âˆ€ {Î“ e A B i}
    â†’ Î“ , A âŠ¢ i # e â¦‚ B
    â†’ Î“ âŠ¢ Sâ‡’ i # (Æ› e) â¦‚ A `â†’ B

  âŠ¢appâ‡ : âˆ€ {Î“ eâ‚ eâ‚‚ A B j}
    â†’ Î“ âŠ¢ â™­ (Sâ‡ j) # eâ‚ â¦‚ A `â†’ B
    â†’ Î“ âŠ¢ â™­ âˆ # eâ‚‚ â¦‚ A
    â†’ Î“ âŠ¢ â™­ j # eâ‚ Â· eâ‚‚ â¦‚ B

  âŠ¢appâ‡’ : âˆ€ {Î“ eâ‚ eâ‚‚ A B j}
    â†’ Î“ âŠ¢ Sâ‡’ j # eâ‚ â¦‚ A `â†’ B
    â†’ Î“ âŠ¢ â™­ Z # eâ‚‚ â¦‚ A
    â†’ Î“ âŠ¢ j # eâ‚ Â· eâ‚‚ â¦‚ B

  âŠ¢sub : âˆ€ {Î“ e A B i}
    â†’ Î“ âŠ¢ â™­ Z # e â¦‚ B
    â†’ B â‰¤ i # A
    â†’ i â‰¢ â™­ Z
    â†’ Î“ âŠ¢ i # e â¦‚ A

  âŠ¢rcd : âˆ€ {Î“ rs As}
    â†’ Î“ âŠ¢r â™­ Z # rs â¦‚ As
    â†’ Î“ âŠ¢ â™­ Z # (ğ•£ rs) â¦‚ As

  âŠ¢prj : âˆ€ {Î“ e l j A}
    â†’ Î“ âŠ¢ â™­ (Sl j) # e â¦‚ Ï„âŸ¦ l â†¦ A âŸ§
    â†’ Î“ âŠ¢ â™­ j # e ğ•¡ l â¦‚ A

data _âŠ¢r_#_â¦‚_ where

  âŠ¢r-nil : âˆ€ {Î“}
    â†’ Î“ âŠ¢r â™­ Z # rnil â¦‚ Top

  âŠ¢r-one : âˆ€ {Î“ e A l}
    â†’ Î“ âŠ¢ â™­ Z # e â¦‚ A
    â†’ Î“ âŠ¢r â™­ Z # râŸ¦ l â†¦ e âŸ§ rnil â¦‚ Ï„âŸ¦ l â†¦ A âŸ§

  âŠ¢r-cons : âˆ€ {Î“ l e rs A As}
    â†’ Î“ âŠ¢ â™­ Z # e â¦‚ A
    â†’ Î“ âŠ¢r â™­ Z # rs â¦‚ As
    â†’ rs â‰¢ rnil
    â†’ Î“ âŠ¢r â™­ Z # râŸ¦ l â†¦ e âŸ§ rs â¦‚ (Ï„âŸ¦ l â†¦ A âŸ§ & As)
