\documentclass{article}
\usepackage{fullwidth}
\usepackage{graphicx} % Required for inserting images

\usepackage{mathpartir}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{xfrac,unicode-math}
% \usepackage{amsthm}
\usepackage{amsthm}
\newtheorem{lemma}{Lemma}

\setmainfont{Gill Sans}
\setmathfont{GFS Neohellenic Math}

\title{Contextual Type Inference}
\author{Xu Xue}

\begin{document}

\maketitle

\section{Snippets}

$$
\Gamma \vdash e \Rightarrow A
$$

$$
\Gamma \vdash e \Leftarrow A
$$

$$
\Gamma \vdash e \Leftrightarrow A
$$

$$
j ::= Z \mid \infty
$$

$$
\Gamma \vdash_{Z} e : A
$$

$$
\Gamma \vdash_{\infty} e : A
$$

$$
\Gamma \vdash_{j} e : A
$$

$$
\Gamma \vdash_{S~Z} e : A \rightarrow B
$$


\begin{mathpar}
  \inferrule*[lab=Lam]
  {\Gamma, x : A \vdash_{j-} e : B}
  {\Gamma \vdash_{j} \lambda x.~ e : A \rightarrow B}

  \inferrule*[lab=App2]
  {\Gamma \vdash_{S~j} e_1 : A \rightarrow B \\
  \Gamma \vdash_Z e_2 : A}
  {\Gamma \vdash_j e_1~e_2 : B}
\end{mathpar}

\begin{align*}
&\Gamma \vdash_{Z} (\lambda x. ~x) ~1 :  Int\\
&\hookrightarrow [App2]~ \Gamma \vdash_{S~Z} \lambda x. ~x : Int \rightarrow Int \quad\quad \Gamma \vdash_{Z} 1 : Int\\
&\hookrightarrow [Lam]~ \Gamma , x : Int \vdash_{Z} x : Int \\
\end{align*}

\begin{align*}
  &\Gamma \vdash_{Z} \lambda x. \lambda y. ((\lambda f. f\ y) : (Int \to Int) \to Int)\ 1\ 2\ (\lambda x. x) :  Int\\
  &\hookrightarrow [App1]~ \Gamma \vdash_{Z} \lambda x. \lambda y. ((\lambda f. f\ y) : (Int \to Int) \to Int)\ 1\ 2\ :  (Int \to Int) \to Int\\
  &\hookrightarrow [App2]~ \Gamma \vdash_{S~Z} \lambda x. \lambda y. ((\lambda f. f\ y) : (Int \to Int) \to Int)\ 1\ :  Int \to (Int \to Int) \to Int\\
  &\hookrightarrow [App2]~ \Gamma \vdash_{S~S~Z} \lambda x. \lambda y. ((\lambda f. f\ y) : (Int \to Int) \to Int) :  Int \to Int \to (Int \to Int) \to Int\\
  &\hookrightarrow [Lam]~ \Gamma, x : Int \vdash_{S~Z} \lambda y. ((\lambda f. f\ y) : (Int \to Int) \to Int) : Int \to (Int \to Int) \to Int\\
  &\hookrightarrow [Lam]~ \Gamma, x : Int, y : Int \vdash_{Z} (\lambda f. f\ y) : (Int \to Int) \to Int : (Int \to Int) \to Int\\
\end{align*}

$$
\Gamma \vdash H \Rightarrow e \Rightarrow A
$$

\begin{align*}
& \Gamma \vdash \square \Rightarrow (\lambda x. ~x) ~1 \Rightarrow Int \\
&\hookrightarrow [App]~ \Gamma \vdash \boxed{1} \rightarrow \square \Rightarrow \lambda x. ~x \Rightarrow Int \to Int \\
&\hookrightarrow [Lam2]~ \Gamma, x : A \vdash \square \Rightarrow x \Rightarrow Int
\end{align*}



\section{Syntax}

\begin{align*}
&\text{Types} \quad\quad &A, B, C, D ::=&~ \mathtt{Int} \mid A \rightarrow B\\
&\text{Expressions} \quad \quad &e::=&~ x \mid \lambda x . ~e \mid e_1~e_2 \mid e : A\\
&\text{Contexts} \quad\quad &\Gamma::=&~ . \mid \Gamma, x : A\\
&\text{Partial Values} \quad \quad &p::=&~ i \mid x \mid e : A\\
&\text{Counters} \quad\quad &j ::=&~ Z \mid \infty \mid S~j\\
&\text{Hints} \quad\quad &H ::=&~ \square \mid A \mid \boxed{e} \rightarrow H\\
\end{align*}

\section{Bidirectional Typing}

\begin{mathpar}
  \inferrule*[lab=T-Lit]
  { }
  {\Gamma \vdash n \Rightarrow Int}

  \inferrule*[lab=T-Var]
  {x : A \in \Gamma}
  {\Gamma \vdash x \Rightarrow A}

  \inferrule*[lab=T-Ann]
  {\Gamma \vdash e \Leftarrow A}
  {\Gamma \vdash e : A \Rightarrow A}

  \inferrule*[lab=T-Lam]
  {\Gamma, x : A \vdash e \Leftarrow B}
  {\Gamma \vdash \lambda x.~e \Leftarrow A \rightarrow B}

  \inferrule*[lab=T-App]
  {\Gamma \vdash e_1 \Rightarrow A \rightarrow B \\
   \Gamma \vdash e_2 \Leftarrow A}
  {\Gamma \vdash e_1~e_2 \Rightarrow B}

  \inferrule*[lab=T-Sub]
  {\Gamma \vdash e \Rightarrow A}
  {\Gamma \vdash e \Leftarrow A}
  \end{mathpar}

\subsection{Counters}

\begin{mathpar}
  \inferrule*[lab=Int]
  { }
  {\Gamma \vdash_Z i : Int}

  \inferrule*[lab=Var]
  {x : A \in \Gamma}
  {\Gamma \vdash_Z x : A}

  \inferrule*[lab=Ann]
  {\Gamma \vdash_{\infty} e : A}
  {\Gamma \vdash_Z (e : A) : A}

  \inferrule*[lab=Lam]
  {\Gamma, x : A \vdash_{\infty} e : B}
  {\Gamma \vdash_{\infty} \lambda x.~ e : A \rightarrow B}

  \inferrule*[lab=App]
  {\Gamma \vdash_Z e_1 : A \rightarrow B \\
  \Gamma \vdash_{\infty} e_2 : A}
  {\Gamma \vdash_Z e_1~e_2 : B}

  \inferrule*[lab=Sub]
  {\Gamma \vdash_Z e : A}
  {\Gamma \vdash_{\infty} e : A}
\end{mathpar}


\section{Decl.}

\subsection{Typing}

\begin{mathpar}
    \inferrule*[lab=Int]
    { }
    {\Gamma \vdash_Z i : Int}

    \inferrule*[lab=Var]
    {x : A \in \Gamma}
    {\Gamma \vdash_Z x : A}

    \inferrule*[lab=Ann]
    {\Gamma \vdash_{\infty} e : A}
    {\Gamma \vdash_Z (e : A) : A}

    \inferrule*[lab=Lam]
    {\Gamma, x : A \vdash_{j-} e : B}
    {\Gamma \vdash_{j} \lambda x.~ e : A \rightarrow B}

    \inferrule*[lab=App1]
    {\Gamma \vdash_Z e_1 : A \rightarrow B \\
    \Gamma \vdash_{\infty} e_2 : A}
    {\Gamma \vdash_Z e_1~e_2 : B}

    \inferrule*[lab=App2]
    {\Gamma \vdash_{S~j} e_1 : A \rightarrow B \\
    \Gamma \vdash_Z e_2 : A}
    {\Gamma \vdash_j e_1~e_2 : B}

    \inferrule*[lab=Sub]
    {\Gamma \vdash_Z e : A \\
    A \sim j}
    {\Gamma \vdash_j e : A}
\end{mathpar}

\subsection{Well-formedness}

\begin{mathpar}
    \inferrule*[lab=S-0]
    { }
    {A \sim Z}

    \inferrule*[lab=S-inf]
    { }
    {A \sim \infty}

    \inferrule*[lab=S-S]
    {B \sim j}
    {A \rightarrow B \sim S ~j}
\end{mathpar}

\section{Algo.}

\subsection{Typing}

\begin{mathpar}
\inferrule*[lab=T-Lit]
{ }
{\Gamma \vdash \square \Rightarrow i \Rightarrow \mathsf{Int}}

\inferrule*[lab=T-Var]
{x : A \in \Gamma}
{\Gamma \vdash \square \Rightarrow x \Rightarrow A}

\inferrule*[lab=T-Ann]
{\Gamma \vdash A \Rightarrow e \Rightarrow B}
{\Gamma \vdash \square \Rightarrow e : A \Rightarrow A}

\inferrule*[lab=T-App]
{\Gamma \vdash \boxed{e_2} \mapsto H \Rightarrow e_1 \Rightarrow A \rightarrow B}
{\Gamma \vdash H \Rightarrow e_1~e_2 \Rightarrow B}

\inferrule*[lab=T-Lam1]
{\Gamma, x : A \vdash B \Rightarrow e \Rightarrow C}
{\Gamma \vdash A \rightarrow B \Rightarrow \lambda x.~e \Rightarrow A \rightarrow C}

\inferrule*[lab=T-Lam2]
{\Gamma \vdash \square \Rightarrow e_2 \Rightarrow A \\
 \Gamma , x : A \vdash H \Rightarrow e \Rightarrow B}
{\Gamma \vdash \boxed{e_2} \rightarrow H \Rightarrow \lambda x.~e \Rightarrow A \rightarrow B}

\inferrule*[lab=T-Sub]
{\Gamma \vdash \square \Rightarrow p \Rightarrow A \\
  A \approx H}
{\Gamma \vdash H \Rightarrow p \Rightarrow A}
\end{mathpar}

\subsection{Well-formedness}

\begin{mathpar}
\inferrule*[lab=S-Empty]
{ }
{\Gamma \vdash A \approx \square}

\inferrule*[lab=S-Type]
{ }
{\Gamma \vdash A \approx A}

\inferrule*[lab=S-Hole]
{\Gamma \vdash A \Rightarrow e \Rightarrow C \\
 \Gamma \vdash B \approx H}
{\Gamma \vdash A \rightarrow B \approx \boxed{e} \rightarrow H}
\end{mathpar}

\section{Properties}

If $\Gamma \vdash H \Rightarrow e \Rightarrow A$ and $(H, A) \hookrightarrow (\bar{e}, T, \bar{A}, A')$ and if $T$ is $\square$, then $\Gamma \vdash_{Z} e \triangleright \bar{e} : A'$, otherwise $\Gamma \vdash_{\infty} e \triangleright \bar{e} : T$

\begin{itemize}
    \item $(H, A) \hookrightarrow (\bar{e}, T, \bar{A}, A')$ is a split function where there's a invariant that
    $H \equiv \bar{e} \rightarrow T$ and $A \equiv \bar{A} \rightarrow A'$
    \item $e \triangleright \bar{e}$ is a constructor function that builds a application term.
\end{itemize}

\begin{itemize}
  \item If $\Gamma \vdash \square \Rightarrow e \Rightarrow A$, then $\Gamma \vdash_Z e : A$.
  \item If $\Gamma \vdash T \Rightarrow e \Rightarrow A$, then $\Gamma \vdash_{\infty} e : T$, where we also know $T \equiv A$.
\end{itemize}

If $\Gamma \vdash_j e : A$ and $(A, j) \hookrightarrow (\bar{A}, T, j')$, then $\Gamma \vdash H \Rightarrow e \Rightarrow A$.

\begin{itemize}
  \item If $j'$ is $Z$, then $H$ is $\bar{e} \rightarrow \square$ and $\Gamma \vdash \bar{e} \Rightarrow \bar{A}$;
  \item If $j'$ is $\infty$, then $H$ is $\bar{e} \rightarrow T$ and $\Gamma \vdash \bar{e} \Rightarrow \bar{A}$.
\end{itemize}

\begin{itemize}
  \item If $\Gamma \vdash_Z e : A$, then $\Gamma \vdash \square \Rightarrow e \Rightarrow A$;
  \item If $\Gamma \vdash_{\infty} e : T$, then $\Gamma \vdash T \Rightarrow e \Rightarrow A$, where we also know $T \equiv A$.image.png
\end{itemize}



$$
\Gamma \vdash_{Z} ((\lambda x.~x) : (Int \to Int) ~\&~ (Bool \to Bool))~1 : Int
$$

$$
\Gamma \vdash_{Z} ((\lambda f. ~f~1) : ((Int \rightarrow Int) \to Int) ~\&~ ((Int \rightarrow Bool) \to Bool)) ~(\lambda x.~x) : Int
$$

\section{Syntax}

\begin{align*}
&\text{Types} \quad\quad &A, B, C, D ::=&~ \mathtt{Int} \mid A \rightarrow B \mid A ~\&~ B\\
&\text{Expressions} \quad \quad &e::=&~ x \mid \lambda x . ~e \mid e_1~e_2 \mid e : A\\
&\text{Contexts} \quad\quad &\Gamma::=&~ . \mid \Gamma, x : A\\
&\text{Partial Values} \quad \quad &p::=&~ i \mid x \mid e : A\\
&\text{Counters} \quad\quad &j ::=&~ Z \mid \infty \mid S~j\\
&\text{Hints} \quad\quad &H ::=&~ \square \mid A \mid \boxed{e} \rightarrow H\\
\end{align*}


\begin{align*}
  &\text{Types} \quad\quad &A, B, C, D, T ::=&~ \mathtt{Int} \mid \mathtt{Top} \mid A \rightarrow B \mid A~\&~B\\
  &\text{Expressions} \quad \quad &e::=&~ x \mid \lambda x . ~e \mid e_1~e_2 \mid e : A\\
  &\text{Partial Values} \quad \quad &p::=&~ i \mid x \mid e : A\\
  &\text{Contexts} \quad\quad &\Gamma::=&~ . \mid \Gamma, x : A\\
  &\text{Check Counters} \quad\quad &j ::=&~ Z \mid \infty \mid S_{\Leftarrow}~j \\
  &\text{Counters} \quad\quad &i ::= &~ \beta ~j \mid S_{\Rightarrow}~i\\
  &\text{Hints} \quad\quad &H ::=&~ \square \mid A \mid \boxed{e} \rightarrow H\\
\end{align*}

\begin{mathpar}
  \inferrule*[lab=Int]
  { }
  {\Gamma \vdash_{\beta ~Z} i : Int}

  \inferrule*[lab=Var]
  {x : A \in \Gamma}
  {\Gamma \vdash_{\beta ~Z} x : A}

  \inferrule*[lab=Ann]
  {\Gamma \vdash_{\beta ~\infty} e : A}
  {\Gamma \vdash_{\beta ~Z} (e : A) : A}

  \inferrule*[lab=Lam]
  {\Gamma, x : A \vdash_{i-} e : B}
  {\Gamma \vdash_{i} \lambda x.~ e : A \rightarrow B}

  \inferrule*[lab=App1]
  {\Gamma \vdash_{\beta ~S_{\Leftarrow}~j} e_1 : A \rightarrow B \\
  \Gamma \vdash_{\beta ~\infty} e_2 : A}
  {\Gamma \vdash_{\beta ~j} e_1~e_2 : B}

  \inferrule*[lab=App2]
  {\Gamma \vdash_{S_{\Rightarrow}~i} e_1 : A \rightarrow B \\
  \Gamma \vdash_{\beta ~Z} e_2 : A}
  {\Gamma \vdash_i e_1~e_2 : B}

  \inferrule*[lab=Sub]
  {\Gamma \vdash_{\beta ~Z} e : A \\
  A <:_{i} B}
  {\Gamma \vdash_i e : B}

  \inferrule*[lab=And]
  {\Gamma \vdash_{\beta ~\infty} e : A \\
   \Gamma \vdash_{\beta ~\infty} e : B}
  {\Gamma \vdash_{\beta ~\infty} e : A ~\&~ B}
\end{mathpar}


\begin{mathpar}
  \inferrule*[lab=S-Refl]
  { }
  {A <:_{\beta ~Z} A}

  \inferrule*[lab=S-Int]
  { }
  {Int <:_{\beta ~\infty} Int}

  \inferrule*[lab=S-Top]
  { }
  {A <:_{\beta ~\infty} \mathtt{Top}}

  \inferrule*[lab=S-Arr]
  {C <:_{\beta~\infty} A \\
   B <:_{i--} D}
  {A \rightarrow B <:_i C \rightarrow D}

  \inferrule*[lab=S-And-L]
  {A <:_i C}
  {A ~\&~ B <:_i C}

  \inferrule*[lab=S-And-R]
  {B <:_i C}
  {A ~\&~ B <:_i C}

  \inferrule*[lab=S-And]
  {A <:_{\beta~\infty} B \\
   A <:_{\beta~\infty} C}
  {A <:_{\beta~\infty} B ~\&~ C}
\end{mathpar}


\begin{mathpar}
  \inferrule*[lab=S-Int]
  { }
  {\Gamma \vdash Int <: Int \rightsquigarrow Int}
  
  \inferrule*[lab=S-Top]
  { }
  {\Gamma \vdash A <: Top \rightsquigarrow Top}
  
  \inferrule*[lab=S-Square]
  { }
  {\Gamma \vdash A <: \square \rightsquigarrow A}
  
  \inferrule*[lab=S-Arr]
  {\Gamma \vdash C <: A \rightsquigarrow A \\
   \Gamma \vdash B <: D \rightsquigarrow D}
  {\Gamma \vdash A \rightarrow B <: C \rightarrow D \rightsquigarrow C \rightarrow D}
  
  \inferrule*[lab=S-Hole]
  {\Gamma \vdash A \Rightarrow e \Rightarrow A \\
   \Gamma \vdash B <: H \rightsquigarrow D}
  {\Gamma \vdash A \rightarrow B <: \boxed{e} \rightarrow H \rightsquigarrow A \rightarrow D}
  
  \inferrule*[lab=S-And-L]
  {\Gamma \vdash A <: H \rightsquigarrow C}
  {\Gamma \vdash A ~\&~ B <: H \rightsquigarrow C}
  
  \inferrule*[lab=S-And-R]
  {\Gamma \vdash B <: H \rightsquigarrow C}
  {\Gamma \vdash A ~\&~ B <: H \rightsquigarrow C}
  
  \inferrule*[lab=S-And]
  {\Gamma \vdash A <: B \rightsquigarrow B \\
   \Gamma \vdash A <: C \rightsquigarrow C}
  {\Gamma \vdash A <: B ~\&~ C \rightsquigarrow B ~\&~ C}
\end{mathpar}   

\begin{align*}
  &\Gamma \vdash_{\beta ~Z} ((\lambda x.~x) : (Int \to Int) ~\&~ (Bool \to Bool))~1 : Int \\
  &\hookrightarrow [App1]~ \Gamma \vdash_{\beta~ S_{\Leftarrow} ~Z} ((\lambda x.~x) : (Int \to Int) ~\&~ (Bool \to Bool)) : Int \rightarrow Int \\
  &\hookrightarrow [Sub]~ \Gamma \vdash_{\beta ~Z} ((\lambda x.~x) : (Int \to Int) ~\&~ (Bool \to Bool)) : (Int \rightarrow Int) ~\&~ (Bool \rightarrow Bool) \\
  &\hookrightarrow [Sub-And-L]~ (Int \rightarrow Int) ~\&~ (Bool \rightarrow Bool) <:_{\beta~ S_{\Leftarrow} ~Z} Int \rightarrow Int \\
  &\hookrightarrow [Sub-Arr]~ Int \rightarrow Int <:_{\beta~ S_{\Leftarrow} ~Z} Int \rightarrow Int
\end{align*}

\begin{mathpar}
  \inferrule*[lab=T-Lit]
  { }
  {\Gamma \vdash \square \Rightarrow i \Rightarrow \mathsf{Int}}
  
  \inferrule*[lab=T-Var]
  {x : A \in \Gamma}
  {\Gamma \vdash \square \Rightarrow x \Rightarrow A}
  
  \inferrule*[lab=T-Ann]
  {\Gamma \vdash A \Rightarrow e \Rightarrow B}
  {\Gamma \vdash \square \Rightarrow e : A \Rightarrow A}
  
  \inferrule*[lab=T-App]
  {\Gamma \vdash \boxed{e_2} \mapsto H \Rightarrow e_1 \Rightarrow A \rightarrow B}
  {\Gamma \vdash H \Rightarrow e_1~e_2 \Rightarrow B}
  
  \inferrule*[lab=T-Lam1]
  {\Gamma, x : A \vdash B \Rightarrow e \Rightarrow C}
  {\Gamma \vdash A \rightarrow B \Rightarrow \lambda x.~e \Rightarrow A \rightarrow C}
  
  \inferrule*[lab=T-Lam2]
  {\Gamma \vdash \square \Rightarrow e_2 \Rightarrow A \\
   \Gamma , x : A \vdash H \Rightarrow e \Rightarrow B}
  {\Gamma \vdash \boxed{e_2} \rightarrow H \Rightarrow \lambda x.~e \Rightarrow A \rightarrow B}

\inferrule*[lab=T-Sub]
{\Gamma \vdash \square \Rightarrow p \Rightarrow A \\
\Gamma \vdash A <: H \rightsquigarrow B}
{\Gamma \vdash H \Rightarrow p \Rightarrow B}

\inferrule*[lab=T-And]
{\Gamma \vdash A \Rightarrow e \Rightarrow A \\
\Gamma \vdash B \Rightarrow e \Rightarrow B}
{\Gamma \vdash A ~\&~ B \Rightarrow e \Rightarrow A ~\&~ B}
\end{mathpar}


$$
\Gamma \vdash \boxed{1} \rightarrow \square \Rightarrow (\lambda x. ~x) : (Int \to Int) ~\&~ (Bool \to Bool) \Rightarrow Int \to Int
$$

\section{System F}

\begin{align*}
  &\text{Types} \quad\quad &A, B, C, D, T ::=&~ a \mid \mathtt{Int} \mid A \rightarrow B \mid \forall a.~A\\
  &\text{Expressions} \quad \quad &e::=&~ x \mid \lambda x . ~e \mid e_1~e_2 \mid e : A \mid \Lambda a.~e \mid e[A]\\
  &\text{Contexts} \quad\quad &\Gamma::=&~ . \mid \Gamma, x : A \mid \Gamma, a\\
  &\text{Counters} \quad\quad &j ::=&~ n \mid \infty\\
\end{align*}

\begin{align*}
  &\text{Hints} \quad\quad &H ::=&~ A \mid \square \mid \boxed{e} \rightarrow H\\
  &\text{Partial Values} \quad \quad &p::=&~ i \mid x \mid e : A\\
  &\text{Contexts} \quad\quad &\Gamma,\Delta::=&~ . \mid \Gamma, x : A \mid \Gamma, a \mid \Gamma, \hat{a} \mid \Gamma, \hat{a}:=A\\
  &\text{Mapping}\quad\quad &\phi ::=&~. \mid \phi, \hat{a}:=A \mid \phi, a
\end{align*}

\begin{mathpar}
  \inferrule*[lab=TAbs]
  {\Gamma, X \vdash_j e : A}
  {\Gamma \vdash_j \Lambda X.~e : \forall X.~A}

  \inferrule*[lab=TApp]
  {\Gamma \vdash_j e : \forall X.~B}
  {\Gamma \vdash_j e[A] : [A/X]B}
\end{mathpar}  

\begin{mathpar}
  
  \inferrule*[lab=S-$\forall$]
  {\Gamma , a \vdash_{\infty} A <: B}
  {\Gamma \vdash_{\infty} \forall a.~A <: \forall a.~B}

  \inferrule*[lab=S-$\forall$L]
  {\Gamma \vdash B \\
   \Gamma \vdash_{S~n} [B/a] A <: C}
  {\Gamma \vdash_{S~ n} \forall a. ~A <: C}

\end{mathpar}  

\begin{align*}
  &\text{Hints} \quad\quad &H ::=&~ A \mid \square \mid \boxed{e} \rightarrow H\\
  &\text{Partial Values} \quad \quad &p::=&~ i \mid x \mid e : A\\
  &\text{Contexts} \quad\quad &\Gamma,\Delta::=&~ . \mid \Gamma, x : A \mid \Gamma, a \mid \Gamma, \hat{a} \mid \Gamma, \hat{a}:=A\\
  &\text{Mapping}\quad\quad &\phi ::=&~. \mid \phi, \hat{a}:=A \mid \phi, a
\end{align*}


\end{document}
