module Record.Decl where

open import Record.Prelude
open import Record.Common

----------------------------------------------------------------------
--+                                                                +--
--+                            Counter                             +--
--+                                                                +--
----------------------------------------------------------------------

infixr 6 ğ•“
infixr 5 ğ•š

data CCounter : Set where
   Z : CCounter
   Sâ‡ : CCounter â†’ CCounter
   Sl : CCounter â†’ CCounter

data ICounter : Set where
   ğ•“ : (j : CCounter) â†’ ICounter
   Sâ‡’ : ICounter â†’ ICounter

data Counter : Set where
   ğ•š : (i : ICounter) â†’ Counter
   âˆ : Counter

ğ•« = ğ•š (ğ•“ (Z))

----------------------------------------------------------------------
--+                                                                +--
--+                           Subtyping                            +--
--+                                                                +--
----------------------------------------------------------------------

infix 5 _â‰¤d_#_
data _â‰¤d_#_ : Type â†’ Counter â†’ Type â†’ Set where
  â‰¤d-Z : âˆ€ {A}
    â†’ A â‰¤d ğ•« # A
  â‰¤d-intâˆ :
      Int â‰¤d âˆ # Int
  â‰¤d-floatâˆ :
      Float â‰¤d âˆ # Float
  â‰¤d-baseâˆ : âˆ€ {n}
    â†’ * n â‰¤d âˆ # * n
  â‰¤d-top : âˆ€ {A}
    â†’ A â‰¤d âˆ # Top
  â‰¤d-arr-âˆ : âˆ€ {A B C D}
    â†’ C â‰¤d âˆ # A
    â†’ B â‰¤d âˆ # D
    â†’ A â‡’ B â‰¤d âˆ # C â‡’ D
  â‰¤d-rcdâˆ : âˆ€ {A B l}
    â†’ A â‰¤d âˆ # B
    â†’ Ï„âŸ¦ l â†¦ A âŸ§ â‰¤d âˆ # Ï„âŸ¦ l â†¦ B âŸ§
  â‰¤d-arr-Sâ‡ : âˆ€ {A B C D j}
    â†’ C â‰¤d âˆ # A
    â†’ B â‰¤d ğ•š (ğ•“ j) # D
    â†’ A â‡’ B â‰¤d ğ•š (ğ•“ (Sâ‡ j)) # A â‡’ D
  â‰¤d-rcd-Sl : âˆ€ {A B l j}
    â†’ A â‰¤d ğ•š (ğ•“ j) # B
    â†’ Ï„âŸ¦ l â†¦ A âŸ§ â‰¤d ğ•š (ğ•“ (Sl j)) # (Ï„âŸ¦ l â†¦ B âŸ§)
  â‰¤d-andâ‚ : âˆ€ {A B C j}
    â†’ A â‰¤d j # C
    â†’ j â‰¢ ğ•«
    â†’ A & B â‰¤d j # C
  â‰¤d-andâ‚‚ : âˆ€ {A B C j}
    â†’ B â‰¤d j # C
    â†’ j â‰¢ ğ•«
    â†’ A & B â‰¤d j # C
  â‰¤d-and : âˆ€ {A B C}
    â†’ A â‰¤d âˆ # B
    â†’ A â‰¤d âˆ # C
    â†’ A â‰¤d âˆ # B & C

â‰¤d-reflâˆ : âˆ€ {A} â†’ A â‰¤d âˆ # A
â‰¤d-reflâˆ {A = Int} = â‰¤d-intâˆ
â‰¤d-reflâˆ {A = Float} = â‰¤d-floatâˆ
â‰¤d-reflâˆ {A = * x} = â‰¤d-baseâˆ
â‰¤d-reflâˆ {A = Top} = â‰¤d-top
â‰¤d-reflâˆ {A = A â‡’ Aâ‚} = â‰¤d-arr-âˆ â‰¤d-reflâˆ â‰¤d-reflâˆ
â‰¤d-reflâˆ {A = A & Aâ‚} = â‰¤d-and (â‰¤d-andâ‚ â‰¤d-reflâˆ Î» ()) (â‰¤d-andâ‚‚ â‰¤d-reflâˆ Î» ())
â‰¤d-reflâˆ {Ï„âŸ¦ l â†¦ A âŸ§} = â‰¤d-rcdâˆ â‰¤d-reflâˆ

----------------------------------------------------------------------
--+                                                                +--
--+                             Typing                             +--
--+                                                                +--
----------------------------------------------------------------------


infix 4 _âŠ¢d_#_â¦‚_
infix 4 _âŠ¢r_#_â¦‚_

data _âŠ¢d_#_â¦‚_ : Context â†’ Counter â†’ Term â†’ Type â†’ Set
data _âŠ¢r_#_â¦‚_ : Context â†’ Counter â†’ Record â†’ Type â†’ Set

data _âŠ¢d_#_â¦‚_ where

  âŠ¢d-c : âˆ€ {Î“ c}
    â†’ Î“ âŠ¢d ğ•« # ğ•” c â¦‚ c-Ï„ c

  âŠ¢d-var : âˆ€ {Î“ x A}
    â†’ Î“ âˆ‹ x â¦‚ A
    â†’ Î“ âŠ¢d ğ•« # ` x â¦‚ A

  âŠ¢d-ann : âˆ€ {Î“ e A}
    â†’ Î“ âŠ¢d âˆ # e â¦‚ A
    â†’ Î“ âŠ¢d ğ•« # (e â¦‚ A) â¦‚ A

  âŠ¢d-lamâ‚ : âˆ€ {Î“ e A B}
    â†’ Î“ , A âŠ¢d âˆ # e â¦‚ B
    â†’ Î“ âŠ¢d âˆ # (Æ› e) â¦‚ A â‡’ B

  âŠ¢d-lamâ‚‚ : âˆ€ {Î“ e A B i}
    â†’ Î“ , A âŠ¢d ğ•š i # e â¦‚ B
    â†’ Î“ âŠ¢d ğ•š (Sâ‡’ i) # (Æ› e) â¦‚ A â‡’ B

  âŠ¢d-appâ‡ : âˆ€ {Î“ eâ‚ eâ‚‚ A B j}
    â†’ Î“ âŠ¢d ğ•š (ğ•“ (Sâ‡ j)) # eâ‚ â¦‚ A â‡’ B
    â†’ Î“ âŠ¢d âˆ # eâ‚‚ â¦‚ A
    â†’ Î“ âŠ¢d ğ•š (ğ•“ j) # eâ‚ Â· eâ‚‚ â¦‚ B

{-
  âŠ¢d-appâˆâˆ : âˆ€ {Î“ eâ‚ eâ‚‚ A B}
    â†’ Î“ âŠ¢d âˆ # eâ‚ â¦‚ A â‡’ B
    â†’ Î“ âŠ¢d âˆ # eâ‚‚ â¦‚ A
    â†’ Î“ âŠ¢d âˆ # eâ‚ Â· eâ‚‚ â¦‚ B
-}    

  âŠ¢d-appâˆ : âˆ€ {Î“ eâ‚ eâ‚‚ A B}
    â†’ Î“ âŠ¢d âˆ # eâ‚ â¦‚ A â‡’ B
    â†’ Î“ âŠ¢d ğ•« # eâ‚‚ â¦‚ A
    â†’ Î“ âŠ¢d âˆ # eâ‚ Â· eâ‚‚ â¦‚ B

  âŠ¢d-appâ‡’ : âˆ€ {Î“ eâ‚ eâ‚‚ A B j}
    â†’ Î“ âŠ¢d ğ•š (Sâ‡’ j) # eâ‚ â¦‚ A â‡’ B
    â†’ Î“ âŠ¢d ğ•« # eâ‚‚ â¦‚ A
    â†’ Î“ âŠ¢d ğ•š j # eâ‚ Â· eâ‚‚ â¦‚ B

  âŠ¢d-sub : âˆ€ {Î“ e A B i}
    â†’ Î“ âŠ¢d ğ•« # e â¦‚ B
    â†’ B â‰¤d i # A
    â†’ i â‰¢ ğ•«
    â†’ Î“ âŠ¢d i # e â¦‚ A

  âŠ¢d-& : âˆ€ {Î“ e A B}
    â†’ Î“ âŠ¢d âˆ # e â¦‚ A
    â†’ Î“ âŠ¢d âˆ # e â¦‚ B
    â†’ Î“ âŠ¢d âˆ # e â¦‚ A & B

  âŠ¢d-rcd : âˆ€ {Î“ rs As}
    â†’ Î“ âŠ¢r ğ•« # rs â¦‚ As
    â†’ Î“ âŠ¢d ğ•« # (ğ•£ rs) â¦‚ As

  âŠ¢d-prj : âˆ€ {Î“ e l j A}
    â†’ Î“ âŠ¢d ğ•š (ğ•“ (Sl j)) # e â¦‚ Ï„âŸ¦ l â†¦ A âŸ§
    â†’ Î“ âŠ¢d ğ•š (ğ•“ j) # e ğ•¡ l â¦‚ A

  âŠ¢d-prjâˆ : âˆ€ {Î“ e l A}
    â†’ Î“ âŠ¢d âˆ # e â¦‚ Ï„âŸ¦ l â†¦ A âŸ§
    â†’ Î“ âŠ¢d âˆ # e ğ•¡ l â¦‚ A

data _âŠ¢r_#_â¦‚_ where

  âŠ¢r-nil : âˆ€ {Î“}
    â†’ Î“ âŠ¢r ğ•« # rnil â¦‚ Top

  âŠ¢r-one : âˆ€ {Î“ e A l}
    â†’ Î“ âŠ¢d ğ•« # e â¦‚ A
    â†’ Î“ âŠ¢r ğ•« # râŸ¦ l â†¦ e âŸ§ rnil â¦‚ Ï„âŸ¦ l â†¦ A âŸ§

  âŠ¢r-cons : âˆ€ {Î“ l e rs A As}
    â†’ Î“ âŠ¢d ğ•« # e â¦‚ A
    â†’ Î“ âŠ¢r ğ•« # rs â¦‚ As
    â†’ Î“ âŠ¢r ğ•« # râŸ¦ l â†¦ e âŸ§ rs â¦‚ (Ï„âŸ¦ l â†¦ A âŸ§ & As)


----------------------------------------------------------------------
--+                                                                +--
--+                            Examples                            +--
--+                                                                +--
----------------------------------------------------------------------

id-fun-& : Term
id-fun-& = (Æ› ` 0) â¦‚ (Int â‡’ Int) & (* 1 â‡’ * 1)

âŠ¢id-fun-& : âˆ… âŠ¢d ğ•« # id-fun-& â¦‚ (Int â‡’ Int) & (* 1 â‡’ * 1)
âŠ¢id-fun-& = âŠ¢d-ann (âŠ¢d-& (âŠ¢d-lamâ‚ (âŠ¢d-sub (âŠ¢d-var Z) â‰¤d-intâˆ (Î» ()))) (âŠ¢d-lamâ‚ (âŠ¢d-sub (âŠ¢d-var Z) â‰¤d-baseâˆ (Î» ()))))

example-1-sub : (Ï„âŸ¦ 1 â†¦ (Int â‡’ Int) & (* 1 â‡’ * 1) âŸ§ & (Ï„âŸ¦ 2 â†¦ Int âŸ§))
                    â‰¤d ğ•š (ğ•“ (Sl (Sâ‡ Z))) # (Ï„âŸ¦ 1 â†¦ Int â‡’ Int âŸ§)
example-1-sub = â‰¤d-andâ‚ (â‰¤d-rcd-Sl (â‰¤d-andâ‚ (â‰¤d-arr-Sâ‡ â‰¤d-intâˆ â‰¤d-Z) (Î» ()))) (Î» ())
